# Firewall migration

## Cтадия 1 - Обследование

- Интерфейсы, их количество, второстепенные адреса на них, DHCP серверы и релаи
- Какая нагрузка в Гб/с и в количестве сессий на файерволл, чтобы хватило пропускной способности
- Маршруты, их количество, Асимметричная маршрутизация
- Антиспуфинг, особенности реализации
- НАТ - логика работы!!!
- Если правил много - то вручную переносить очень долго, внимательно изучить
- Изучить логику работы Identity Based Policies, если они есть....
- По максимуму избавится от отрицаний в объектах и правилах, используются ли объекты с исключениями
- Телефония! SIP!, какой объект сервиса используется для разрешения телефонии, настроена ли инспекция высокого уровня в этом сервисе, или эти инспекции настраиваются централизовано? Открыты ли динамические порты вручную или используется инспекция? есть ли NAT для телефонного трафика?
- Системы мониторинга заказчика, особенности работы
- Правила с аутентификацией, каптив порталы
- Правила с FQDN или другими замутами
- Выключенные правила
- Как происходит взаимодействие если лезут изнутри сети на внешний адрес который тут же натится во внутренний
- Группы и адреса с отрицанием и исключением
- Неиспользуемые правила
- IPS
- Application control
- Policy routing
- Протоколы маршрутизации
- Логирование: что, куда и сколько
- Наличие правил allow any any или deny много чего
- Наличие VPN туннелей
- Количество правил
- Наличие виртуальных систем, связи виртуальной между ними, количество ресурсов выделяемых им, наличие пересекающихся виланов между ними
- Методы импорта и экспорта правил и политик

## Стадия 2 - Подготовка или "за неделю до миграции"

На новом продакшн оборудовании проверить:

- ДНС
- НТП
- лицензию
- обновить сигнаторы и включить IPS
- добавить девайс в аналайзер
- установку политики
- кластер
- количество места в аналайзере

Если переносим только несколько VLAN, то тогда нужно перенести все правила хоть как-то связанные с ними!!!
Подготовить команды для анализа производительности

## Cтадия 3 - Переключение

- За 15 мин до начала и после переключения проверить: количество сессий, поток траффика в Гб/c
- После переключения: Таблица маршрутизации, пинг шлюзов

Особенности вендоров

Fortigate
- Пинги нужно открывать отдельно для каждого ВИПА, и соурс ната
- Учитывать пересечение випов если они перенаправялют в разные внутренние адреса
- Нельзя отключить антиспуфинг для отдельных интерфейсов

## Allow any any

- Received bytes >1, most of traffic less then 1 is usually junk!
- Correct VDOM
- Correct Allow rule ID
- Random ports are usually results of: RPC, Torrent, IP phone protocols
- Kerberos and LDAP are usually results of AD or Vcentre
- Small packets are usually DNS and NTP and SNMP and Skinny and custom applications (keepalives) and ping
- Keep rules to connect to FW itself
- Netbios name service - UDP 137 is not used
- 55777 TCP is Vipnet, as well as IP241
- Application control is really useful
- 11.0.0.0 and 12.0.0.0 IPs are Vipnet
- Use any as rare as possible, 10.0.0.0/8 or Internet objects is better
- Do not add dynamic ports, they are trash, only based on request
- It is better when IPS is turned on, to see attacks
