# PKI

## Certificate

- X.509 version 3 standard is used
- Old standard, used in deffirernt areas: email, web...
- X.509 starndard uses description language Abstract Syntax Notation One - ASN.1 - to specify information contained in a certificate
- Data structure in described in ASN.1:

```
Certificate ::= SEQUENCE {
    tbsCertificate  TBSCertificate,
    signatureAlgorithm  AlgorithmIdentifier
    signatureValue  BIT STRING
}
```

- This data structure contains three fields:
    - tbsCertificate - to be signed certificate, all the information that we want to sign, for example: domain name, expiry date, public key....
    - signatureAlgorithm - algorithm used to sign - is not in the certificate itself - is  applied to the certificate as a whole and stored separately for verification purposes
    - signature Value - the signature from CA - is not in certificate itself -  applied to the certificate as a whole and stored separately for verification purposes


### Certificate formats

`ASN.1 > DER > Base64 > PEM`

- DER - bytes format
- DER is converted to base64 for comfort
- Base64 is wraped into PEM format for convenience

Convert pem to ASN.1: `openssl x509 -in google.pem -text`

### Certificate generation

- Generate public and private keys - two big numbers - possible algorithms:  RSA, EcDSA, EdDSA, DSA
- Generate a csr: just a text file with public key and additional data
- The CSR is signed by the private key to prove ownership
- Send CSR to CA
- The CA verifies requester identity
- The CA uses its own private key to sign the CSR information - The algorithm used for this signature must match the CA’s key type - the same as for key generation + hash algorithm
- This produces a digital signature over the CSR's data
- A new object is generated: the X.509 certificate
- The serial number is generated by the CA, not by the device and not from the CSR
- Send certificate back from CA to device

The CA generates:

- Serial number
- Validity period
- Issuer field
- Signature algorithm
- Signature itself
- All extensions:
    - Key Usage
    - Extended Key Usage (EKU)
    - Basic Constraints
    - Subject Alternative Name (SAN)
    - Authority Key Identifier (AKI)
    - Subject Key Identifier (SKI)
    - CRL Distribution Points (CRLDP)
    - Authority Information Access (AIA)
    - Certificate Policies
    - Serial Number
- Certificate version
- Policy OIDs
- Revocation pointers (CRL, OCSP)
- SKI + AKI (computed by CA)

The CA never uses the CSR “as-is.” It only uses the CSR’s:

- Public key
- Subject DN (sometimes modified)
- Requested extensions (accepted or rejected)

Everything else is constructed by the CA

### Certificate renewal

- Can be done with generating new key pair
- Can be done using old keys, but new CSR
- Even without a new key pair serial number will be new, as well as all other things from CA 
- Everything else is the same as in new cert generation

### Self-signed certificate

In self-signed certificate all data in Subject Name is identical to all data in Issuer Name section.

## OCSP

## SCEP

## CRL

## CA
- CA stays offline
- CA signs subordinate CA: encrypts its hash with CA private key
- Subordinate CA signs server certificate.
- Server sends to client its cert + subordinate CA or many subordinates
- Enroll means to send public key and identity information to CA, so CA can issue an identity certificate

## Certificate transparancy

- CA should add each issued certificate to a giant log
- Chrome rejects certs not in the log